# 客户管理模块

## 快速开始

### 1. 安装依赖

由于使用了Recharts绘制消费趋势图，需要安装：

```bash
npm install recharts
```

### 2. 导入组件

```javascript
import ClientList from '@/components/ClientList';
```

### 3. 在路由中使用

```javascript
import ClientList from '@/components/ClientList';

// 在路由配置中
{
  path: '/clients',
  element: <ClientList />,
  meta: {
    title: '客户管理',
    requiresAuth: true
  }
}
```

### 4. 权限配置

确保你的 Redux store 中包含用户信息：

```javascript
// Redux state 结构
{
  user: {
    currentUser: {
      userId: 1,
      userName: '张三',
      roles: ['admin', 'client_manager'] // 角色列表
    }
  }
}
```

## 功能说明

### 主要功能

1. **客户列表**
   - 分页展示（默认15条/页）
   - 按累计消费、最近下单时间排序
   - 显示客户名称、联系人、电话、等级、标签、订单数、累计消费

2. **客户搜索**
   - 关键词搜索（客户名称）
   - 标签多选筛选（支持筛选包含所有选中标签的客户）
   - 客户等级筛选（普通/VIP）

3. **新增客户**
   - 客户名称（唯一性校验）
   - 联系人、电话（手机号格式校验）
   - 邮箱（格式校验）、地址
   - 客户等级（普通/VIP）
   - 标签（多选，支持自定义新标签）
   - 备注

4. **编辑客户**
   - 可修改所有字段
   - 客户名称支持修改但需唯一性校验

5. **客户详情（4个标签页）**
   - **基础信息**：完整展示客户信息，支持编辑按钮
   - **标签管理**：添加/删除标签，新标签自动加入系统标签库
   - **历史订单**：显示所有订单（按时间倒序）
   - **消费趋势**：折线图展示近12个月消费金额和订单数（双Y轴）

6. **删除客户**
   - 有历史订单的客户无法删除
   - 删除前二次确认

### 权限控制

| 角色 | 权限 |
|------|------|
| admin | 所有操作（新增、编辑、删除、查看详情） |
| client_manager | 所有操作（新增、编辑、删除、查看详情） |
| photographer | 仅查看列表和详情 |
| retoucher | 仅查看列表和详情 |
| finance | 仅查看列表和详情（额外显示未收款金额） |

### 客户等级

- **普通客户**：普通标签（灰色）
- **VIP客户**：金色标签 + 皇冠图标

### 标签系统

- **标签筛选**：支持多选，筛选出包含所有选中标签的客户
- **标签管理**：在客户详情中可添加/删除标签
- **自定义标签**：输入新标签名称后回车，自动创建并添加到系统标签库

## API 接口要求

客户管理模块需要以下后端 API 接口支持：

### 客户相关
- `GET /api/clients` - 获取客户列表
- `GET /api/clients/:id` - 获取客户详情
- `POST /api/clients` - 创建客户
- `PUT /api/clients/:id` - 更新客户
- `DELETE /api/clients/:id` - 删除客户
- `GET /api/clients/check-name` - 检查客户名称是否存在

### 订单相关
- `GET /api/clients/:id/orders` - 获取客户历史订单

### 趋势相关
- `GET /api/clients/:id/consumption-trend` - 获取客户消费趋势

### 标签相关
- `GET /api/clients/tags` - 获取所有标签
- `POST /api/clients/tags` - 创建新标签
- `PUT /api/clients/:id/tags` - 更新客户标签

### 统计相关
- `GET /api/clients/:id/statistics` - 获取客户统计数据

详细的 API 接口规范请参考 `CLIENT_DOCUMENTATION.md`。

## 使用示例

### 新增客户流程

```
1. 点击"新增客户"按钮
2. 填写客户信息：
   - 客户名称：ABC服装公司
   - 联系人：张三
   - 电话：13800138000
   - 邮箱：abc@example.com
   - 客户等级：VIP客户
   - 标签：选择"鞋类客户"、"月结客户"，或输入新标签
3. 点击"创建"按钮
4. 创建成功
```

### 标签筛选流程

```
1. 在搜索栏选择标签：选择"鞋类客户"和"月结客户"
2. 点击"搜索"按钮
3. 系统筛选出同时拥有这两个标签的客户
```

### 查看消费趋势流程

```
1. 点击客户列表的"详情"按钮
2. 在详情抽屉中切换到"消费趋势"标签页
3. 查看近12个月的消费金额折线图（蓝色）和订单数折线图（绿色）
```

## 常见问题

### 1. 客户列表不显示数据
- 检查 API 返回数据格式是否正确
- 确认后端接口是否正常
- 查看浏览器控制台错误信息

### 2. 客户名称唯一性校验失败
- 确保后端实现了客户名称检查接口
- 检查接口返回格式是否正确

### 3. 消费趋势图不显示
- 确认是否已安装 recharts：`npm install recharts`
- 检查后端是否返回了正确的趋势数据

### 4. 标签筛选不生效
- 确认后端支持标签多选筛选
- 检查标签ID是否正确传递

### 5. 有订单的客户无法删除
- 这是预期行为，保护数据完整性
- 只有无历史订单的客户才能删除

## 样式自定义

所有 LESS 变量都可以通过修改对应的 `.less` 文件进行自定义：

- `ClientList.less` - 主容器样式
- `ClientSearchBar.less` - 搜索栏样式
- `ClientTable.less` - 表格样式
- `ClientFormDrawer.less` - 表单抽屉样式
- `ClientDetailDrawer.less` - 详情抽屉样式

## 更新日志

### v1.0.0 (2025-01-05)
- 初始版本
- 完整的客户管理功能
- 客户名称唯一性校验
- 标签系统（多选筛选、自定义标签）
- 客户详情（4个标签页）
- 消费趋势图（Recharts）
- 权限控制
- 删除保护（有订单不可删除）
