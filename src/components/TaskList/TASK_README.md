# 任务管理模块

## 快速开始

### 1. 导入组件

```javascript
import TaskList from '@/components/TaskList';
```

### 2. 在路由中使用

```javascript
import TaskList from '@/components/TaskList';

// 在路由配置中
{
  path: '/tasks',
  element: <TaskList />,
  meta: {
    title: '任务管理',
    requiresAuth: true
  }
}
```

### 3. 权限配置

确保你的 Redux store 中包含用户信息：

```javascript
// Redux state 结构
{
  user: {
    currentUser: {
      userId: 1,
      userName: '张三',
      roles: ['admin', 'photographer'] // 角色列表
    }
  }
}
```

## 功能说明

### 主要功能

1. **任务视图切换**
   - 我的任务：显示分配给当前用户的任务
   - 所有任务：显示所有任务（仅管理员可见）

2. **任务筛选**
   - 按任务状态筛选（未开始/进行中/已完成/已退回）
   - 按任务类型筛选（拍摄/后期）

3. **任务分配（仅管理员）**
   - 选择关联订单
   - 选择任务类型（拍摄/后期）
   - 选择负责人（根据任务类型自动筛选）
   - 设置截止日期
   - **产能检查**：系统自动检查员工产能，显示以下状态：
     - ✅ 可分配：员工产能充足
     - ⚠️ 产能紧张：接近满载，提供警告
     - ❌ 产能超载：已超载，需要强制分配选项

4. **进度更新**
   - 滑块设置进度（0-100%）
   - 填写进度说明
   - 进度达到100%自动标记为已完成

5. **任务退回**
   - 退回类型选择：
     - 重拍：要求重新拍摄
     - 重修：要求重新修图
     - 补拍/补修：要求补充拍摄或修改部分内容
   - 填写详细退回原因

6. **任务详情**
   - 任务基本信息
   - 进度历史记录（时间轴展示）
   - 成果上传：
     - 支持格式：JPG、PNG、MP4
     - 单文件大小限制：10MB
     - 图片自动预览
     - 视频文件显示播放图标

### 交互特性

1. **进度条显示**
   - 正常任务：蓝色进度条
   - 即将逾期（<24h）：橙色进度条
   - 已逾期：红色进度条

2. **截止日期提醒**
   - 正常：黑色文字
   - 即将逾期（<24h）：橙色文字 + 提示图标
   - 已逾期：红色文字 + 提示图标

3. **产能检查**
   - 实时检查员工当前负载
   - 显示当前负载/最大负载
   - 显示可用槽位数
   - 产能不足时提供强制分配选项

4. **状态标签**
   - 未开始：灰色
   - 进行中：蓝色
   - 已完成：绿色
   - 已退回：红色

### 权限说明

| 角色 | 权限 |
|------|------|
| admin | 所有操作（分配任务、查看所有任务、更新进度、退回任务、上传成果） |
| client_manager | 分配任务、查看所有任务 |
| photographer | 查看自己的任务、更新进度、上传成果 |
| retoucher | 查看自己的任务、更新进度、上传成果 |

## API 接口要求

任务管理模块需要以下后端 API 接口支持：

### 任务相关
- `GET /api/tasks` - 获取任务列表
- `GET /api/tasks/my-tasks` - 获取我的任务
- `GET /api/tasks/:id` - 获取任务详情
- `POST /api/tasks` - 创建任务（分配任务）
- `PUT /api/tasks/:id` - 更新任务
- `PUT /api/tasks/:id/progress` - 更新任务进度
- `POST /api/tasks/:id/return` - 退回任务
- `DELETE /api/tasks/:id` - 删除任务

### 产能检查
- `POST /api/tasks/check-capacity` - 检查员工产能

### 进度历史
- `GET /api/tasks/:id/progress-history` - 获取进度历史记录

### 成果管理
- `GET /api/tasks/:id/results` - 获取任务成果列表
- `POST /api/tasks/:id/results` - 上传任务成果
- `DELETE /api/tasks/:taskId/results/:resultId` - 删除任务成果

### 其他
- `GET /api/tasks/statistics` - 获取任务统计数据
- `GET /api/employees` - 获取员工列表
- `GET /api/orders` - 获取订单列表（用于分配任务）

详细的 API 接口规范请参考 `TASK_DOCUMENTATION.md`。

## 样式自定义

所有 LESS 变量都可以通过修改对应的 `.less` 文件进行自定义：

- `TaskList.less` - 主容器样式
- `TaskFilter.less` - 筛选器样式
- `TaskTable.less` - 表格样式
- `AssignTaskModal.less` - 分配任务弹窗样式
- `TaskDetailDrawer.less` - 详情抽屉样式

## 数据联动

### 1. 任务进度同步订单进度
当任务进度更新时，系统会自动同步到关联订单的整体进度：

```
订单整体进度 = (所有任务进度之和) / 任务总数
```

### 2. 任务完成自动更新订单状态
任务完成后，系统会根据以下规则自动更新订单状态：

- 拍摄任务完成 → 订单状态更新为"待后期"
- 后期任务完成 → 订单状态更新为"待验收"
- 所有任务完成 → 订单状态更新为"待验收"

### 3. 任务状态变更通知
任务状态变更时，系统会自动发送通知：

- 任务分配 → 通知负责人
- 进度更新 → 通知管理员
- 任务退回 → 通知负责人
- 任务完成 → 通知管理员和客户

## 常见问题

### 1. 任务列表不显示数据
- 检查 API 返回数据格式是否正确
- 确认后端接口是否正常
- 查看浏览器控制台是否有错误信息

### 2. 产能检查失败
- 确保后端实现了产能检查接口
- 检查员工数据是否包含产能相关字段
- 查看网络请求响应错误信息

### 3. 文件上传失败
- 检查后端是否支持 `multipart/form-data`
- 确认文件大小是否超过限制（10MB）
- 确认文件格式是否正确（JPG/PNG/MP4）
- 查看网络请求响应错误信息

### 4. 权限控制不生效
- 确认 Redux store 中的用户信息格式正确
- 检查 `currentUser.roles` 数组是否包含正确的角色标识

### 5. 进度更新后状态未自动变化
- 确认后端是否正确实现了进度更新逻辑
- 检查进度是否真的达到了100%
- 查看后端返回的任务状态是否正确

## 更新日志

### v1.0.0 (2025-01-05)
- 初始版本
- 完整的任务管理功能
- 产能检查功能
- 任务退回功能
- 成果上传功能
- 进度历史记录
- 权限控制
- 数据联动
